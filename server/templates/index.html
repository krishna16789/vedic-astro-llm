<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astrology LLM</title>
    <!-- Markdown rendering library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .tab-content.active {
            display: block;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
        }

        /* Markdown formatting styles */
        .message.assistant h1 {
            font-size: 1.8rem;
            color: #667eea;
            margin: 15px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .message.assistant h2 {
            font-size: 1.4rem;
            color: #667eea;
            margin: 12px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .message.assistant h3 {
            font-size: 1.2rem;
            color: #5568d3;
            margin: 10px 0 6px 0;
        }

        .message.assistant h4 {
            font-size: 1.1rem;
            color: #333;
            margin: 8px 0 4px 0;
        }

        .message.assistant ul, .message.assistant ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message.assistant li {
            margin: 5px 0;
        }

        .message.assistant p {
            margin: 8px 0;
        }

        .message.assistant strong {
            color: #333;
            font-weight: 600;
        }

        .message.assistant code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message.assistant pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message.assistant pre code {
            background: none;
            padding: 0;
        }

        .message.assistant hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 15px 0;
        }

        .message.assistant blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 10px 0;
            color: #666;
            font-style: italic;
        }

        .message.assistant table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .message.assistant th, .message.assistant td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }

        .message.assistant th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .message.system {
            background: #fff3cd;
            border: 1px solid #ffc107;
            max-width: 100%;
            text-align: center;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Chart Calculator */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-search {
            position: relative;
        }

        .location-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .location-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .location-item:hover {
            background: #f8f9fa;
        }

        .location-item:last-child {
            border-bottom: none;
        }

        .chart-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .chart-results h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .planet-info {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .planet-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .planet-details {
            font-size: 0.9rem;
            color: #666;
        }

        /* Rasi Chart */
        .rasi-chart-container {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .rasi-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 120px);
            gap: 2px;
            background: #333;
            border: 2px solid #333;
            max-width: 600px;
            margin: 0 auto;
        }

        .rasi-house {
            background: #fff;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 0.85rem;
        }

        .house-number {
            position: absolute;
            top: 5px;
            left: 5px;
            font-weight: bold;
            color: #999;
            font-size: 0.7rem;
        }

        .house-sign {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .house-planets {
            text-align: center;
            font-size: 0.75rem;
            color: #333;
        }

        .planet-symbol {
            display: inline-block;
            margin: 2px;
            padding: 2px 4px;
            background: #e3f2fd;
            border-radius: 3px;
        }

        .ascendant-marker {
            color: #f44336;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-ok {
            background: #28a745;
        }

        .status-warning {
            background: #ffc107;
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8rem;
            }

            .tabs {
                flex-direction: column;
            }

            .rasi-chart {
                grid-template-rows: repeat(4, 100px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåü Vedic Astrology LLM</h1>
            <p>AI-Powered Vedic Astrology Consultation & Chart Calculator</p>
            <div style="margin-top: 10px; font-size: 0.9rem;">
                <span id="mistral-status"></span>
                <span id="ephemeris-status"></span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('chat', event)">üí¨ Chat with AI</button>
            <button class="tab" onclick="switchTab('calculator', event)">üìä Chart Calculator</button>
            <button class="tab" onclick="switchTab('rasi', event)">üîÆ Rasi Chart (D1)</button>
            <button class="tab" onclick="switchTab('divisional', event)">üìê Divisional Charts</button>
            <button class="tab" onclick="switchTab('shadbala', event)">üí™ Shadbala</button>
            <button class="tab" onclick="switchTab('bhavabala', event)">üè† Bhavabala</button>
            <button class="tab" onclick="switchTab('dasha', event)">‚è∞ Dasha Periods</button>
            <button class="tab" onclick="switchTab('nakshatra', event)">‚≠ê Nakshatra Info</button>
            <button class="tab" onclick="switchTab('saved', event)">üíæ Saved Charts</button>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content active">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message system">
                        Welcome! Ask me anything about Vedic astrology, planetary positions, nakshatras, or birth chart analysis.
                    </div>
                </div>
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="chat-input" 
                        placeholder="Ask about Vedic astrology..."
                        onkeypress="handleChatKeyPress(event)"
                    >
                    <button class="btn" id="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-tab" class="tab-content">
            <div class="calculator-grid">
                <div>
                    <h2 style="margin-bottom: 20px; color: #667eea;">Birth Details</h2>
                    <form onsubmit="calculateChart(event)">
                        <div class="form-group location-search">
                            <label for="location-search">Birth Place</label>
                            <input 
                                type="text" 
                                id="location-search"
                                placeholder="Search for city..."
                                oninput="searchLocation(this.value)"
                            >
                            <div id="location-results" class="location-results" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="datetime">Date & Time (Local Time)</label>
                            <input
                                type="datetime-local"
                                id="datetime"
                                required
                                value="1990-01-01T10:30"
                            >
                        </div>
                        <div class="form-group">
                            <label for="timezone">Timezone Offset from UTC</label>
                            <select id="timezone" class="form-control" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <option value="5.5" selected>IST (UTC+5:30)</option>
                                <option value="0">GMT/UTC (UTC+0:00)</option>
                                <option value="-5">EST (UTC-5:00)</option>
                                <option value="-6">CST (UTC-6:00)</option>
                                <option value="-7">MST (UTC-7:00)</option>
                                <option value="-8">PST (UTC-8:00)</option>
                                <option value="1">CET (UTC+1:00)</option>
                                <option value="8">CST China (UTC+8:00)</option>
                                <option value="9">JST (UTC+9:00)</option>
                                <option value="10">AEST (UTC+10:00)</option>
                            </select>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Select the timezone of the birth time. Auto-detected: <span id="detected-tz"></span>
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="latitude">Latitude</label>
                            <input 
                                type="number" 
                                id="latitude" 
                                step="0.0001" 
                                required
                                placeholder="e.g., 28.6139 (Delhi)"
                                value="28.6139"
                            >
                        </div>
                        <div class="form-group">
                            <label for="longitude">Longitude</label>
                            <input 
                                type="number" 
                                id="longitude" 
                                step="0.0001" 
                                required
                                placeholder="e.g., 77.2090 (Delhi)"
                                value="77.2090"
                            >
                        </div>
                        <button type="submit" class="btn" id="calc-btn" style="width: 100%; margin-bottom: 10px;">
                            Calculate Chart
                        </button>
                        <button type="button" class="btn" onclick="saveCurrentChart()" style="width: 100%; background: #28a745;">
                            üíæ Save Chart
                        </button>
                    </form>
                </div>
                <div>
                    <h2 style="margin-bottom: 20px; color: #667eea;">Chart Results</h2>
                    <div class="chart-results" id="chart-results">
                        <p style="color: #999; text-align: center; padding: 50px 0;">
                            Enter birth details and click "Calculate Chart" to see planetary positions
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rasi Chart Tab -->
        <div id="rasi-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Rasi Chart (D1) - South Indian Style</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-small" onclick="generateRasiChart()">Generate Chart</button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Calculate chart first in the Chart Calculator tab, then click Generate Chart
                </p>
            </div>
            <div id="rasi-chart-display">
                <p style="color: #999; text-align: center; padding: 50px 0;">
                    Calculate a birth chart first, then generate the Rasi chart visualization
                </p>
            </div>
        </div>

        <!-- Divisional Charts Tab -->
        <div id="divisional-tab" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Divisional Charts (Vargas)</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 0.9rem;">
                        Calculate a birth chart first, then select a divisional chart
                    </p>
                    <div style="margin: 20px 0;">
                        <select id="varga-select" style="padding: 10px; font-size: 1rem; border-radius: 8px; border: 2px solid #e0e0e0;">
                            <option value="D1">D1 - Rasi (Birth Chart)</option>
                            <option value="D2">D2 - Hora (Wealth)</option>
                            <option value="D3">D3 - Drekkana (Siblings)</option>
                            <option value="D4">D4 - Chaturthamsa (Property)</option>
                            <option value="D7">D7 - Saptamsa (Children)</option>
                            <option value="D9" selected>D9 - Navamsa (Spouse/Dharma)</option>
                            <option value="D10">D10 - Dasamsa (Career)</option>
                            <option value="D12">D12 - Dwadasamsa (Parents)</option>
                            <option value="D16">D16 - Shodasamsa (Vehicles)</option>
                            <option value="D20">D20 - Vimsamsa (Spiritual)</option>
                            <option value="D24">D24 - Chaturvimsamsa (Education)</option>
                            <option value="D27">D27 - Nakshatramsa (Strengths)</option>
                            <option value="D30">D30 - Trimsamsa (Evils)</option>
                            <option value="D40">D40 - Khavedamsa (Auspicious)</option>
                            <option value="D45">D45 - Akshavedamsa (Character)</option>
                            <option value="D60">D60 - Shashtiamsa (Karma)</option>
                        </select>
                        <button class="btn" onclick="generateDivisionalChart()" style="margin-left: 10px;">Generate Chart</button>
                    </div>
                </div>
                <div id="divisional-chart-display">
                    <p style="color: #999; text-align: center; padding: 50px 0;">
                        Select a divisional chart and click Generate Chart
                    </p>
            </div>
        </div>

        <!-- Shadbala Tab -->
        <div id="shadbala-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Shadbala (Six-fold Planetary Strength)</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-small" onclick="calculateShadbala()">Calculate Shadbala</button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Calculate chart first in the Chart Calculator tab
                </p>
            </div>
            <div id="shadbala-results" style="max-width: 1000px; margin: 0 auto;">
                <p style="color: #999; text-align: center; padding: 50px 0;">
                    Calculate a birth chart first, then click Calculate Shadbala
                </p>
            </div>
        </div>

        <!-- Bhavabala Tab -->
        <div id="bhavabala-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Bhavabala (House Strength)</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-small" onclick="calculateBhavabala()">Calculate Bhavabala</button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Calculate chart first in the Chart Calculator tab
                </p>
            </div>
            <div id="bhavabala-results" style="max-width: 1000px; margin: 0 auto;">
                <p style="color: #999; text-align: center; padding: 50px 0;">
                    Calculate a birth chart first, then click Calculate Bhavabala
                </p>
            </div>
        </div>

        <!-- Dasha Tab -->
        <div id="dasha-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Vimshottari Dasha Periods</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-small" onclick="calculateDasha()">Calculate Dasha</button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Calculate chart first in the Chart Calculator tab
                </p>
            </div>
            <div id="dasha-results" style="max-width: 1200px; margin: 0 auto;">
                <p style="color: #999; text-align: center; padding: 50px 0;">
                    Calculate a birth chart first, then click Calculate Dasha
                </p>
            </div>
        </div>

        <!-- Nakshatra Attributes Tab -->
        <div id="nakshatra-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Nakshatra Attributes & Karakas</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-small" onclick="calculateNakshatraAttributes()">Calculate Attributes</button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Shows Karakas, Yoni, Gana, Nadi, Varna, and more
                </p>
            </div>
            <div id="nakshatra-results" style="max-width: 1200px; margin: 0 auto;">
                <p style="color: #999; text-align: center; padding: 50px 0;">
                    Calculate a birth chart first, then click Calculate Attributes
                </p>
            </div>
        </div>

        <!-- Saved Charts Tab -->
        <div id="saved-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #667eea; text-align: center;">Saved Birth Charts</h2>
            <div id="saved-charts-list" style="max-width: 800px; margin: 0 auto;">
                <p style="color: #999; text-align: center;">No saved charts yet</p>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [];
        let currentChartData = null;
        let currentInputData = null;  // Store original input for Rasi chart
        let searchTimeout = null;
        let savedCharts = [];  // Store multiple saved charts

        // Load saved charts on startup
        window.addEventListener('load', function() {
            loadSavedCharts();
            updateSavedChartsList();  // Update display after loading
        });

        function loadSavedCharts() {
            const saved = localStorage.getItem('vedic_astro_charts');
            if (saved) {
                try {
                    savedCharts = JSON.parse(saved);
                    console.log('Loaded charts from localStorage:', savedCharts.length);
                } catch (e) {
                    console.error('Error loading saved charts:', e);
                    savedCharts = [];
                }
            }
        }

        function saveCurrentChart() {
            if (!currentInputData) {
                alert('Please calculate a chart first');
                return;
            }

            const name = prompt('Enter a name for this chart:');
            if (!name) return;

            const chartToSave = {
                id: Date.now(),
                name: name,
                data: currentInputData,
                savedAt: new Date().toISOString()
            };

            savedCharts.push(chartToSave);
            localStorage.setItem('vedic_astro_charts', JSON.stringify(savedCharts));
            alert('Chart saved successfully!');
            updateSavedChartsList();
        }

        function loadChart(chartId) {
            const chart = savedCharts.find(c => c.id === chartId);
            if (!chart) return;

            // Populate form fields
            document.getElementById('datetime').value = chart.data.datetime;
            document.getElementById('latitude').value = chart.data.latitude;
            document.getElementById('longitude').value = chart.data.longitude;
            document.getElementById('timezone').value = chart.data.timezone_offset;

            // Automatically calculate the chart
            calculateChart(new Event('submit'));
        }

        function deleteChart(chartId) {
            if (!confirm('Are you sure you want to delete this chart?')) return;

            savedCharts = savedCharts.filter(c => c.id !== chartId);
            localStorage.setItem('vedic_astro_charts', JSON.stringify(savedCharts));
            updateSavedChartsList();
        }

        function updateSavedChartsList() {
            const container = document.getElementById('saved-charts-list');
            if (!container) return;

            if (savedCharts.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No saved charts yet</p>';
                return;
            }

            container.innerHTML = savedCharts.map(chart => {
                const date = new Date(chart.savedAt).toLocaleString();
                return `
                    <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${chart.name}</strong><br>
                            <small style="color: #666;">${date}</small>
                        </div>
                        <div>
                            <button class="btn btn-small" onclick="loadChart(${chart.id})" style="margin-right: 5px;">Load</button>
                            <button class="btn btn-small" onclick="deleteChart(${chart.id})" style="background: #dc3545;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Check server health on load
        window.addEventListener('load', checkHealth);

        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const mistralStatus = document.getElementById('mistral-status');
                const ephemerisStatus = document.getElementById('ephemeris-status');
                
                mistralStatus.innerHTML = data.model_loaded
                    ? `<span class="status-indicator status-ok"></span>Mistral 7B: Loaded (${data.device})`
                    : '<span class="status-indicator status-warning"></span>Mistral 7B: Loading...';
                    
                ephemerisStatus.innerHTML = data.ephemeris_available
                    ? '<span class="status-indicator status-ok"></span>Calculations: Ready'
                    : '<span class="status-indicator status-warning"></span>Calculations: Unavailable';
                    
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        function switchTab(tabName, evt) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            const messagesContainer = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('send-btn');

            // Add user message
            addMessage('user', message);
            input.value = '';
            chatHistory.push({ role: 'user', content: message });

            // Disable input while processing
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory
                    })
                });

                const data = await response.json();
                
                // Add assistant response
                addMessage('assistant', data.response);
                chatHistory.push({ role: 'assistant', content: data.response });

                if (data.using_mock) {
                    addMessage('system', '‚ö†Ô∏è Running in mock mode or model still loading.');
                }

            } catch (error) {
                addMessage('system', '‚ùå Error: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send';
            }
        }

        function addMessage(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Render markdown for assistant messages
            if (role === 'assistant' && typeof marked !== 'undefined') {
                try {
                    messageDiv.innerHTML = marked.parse(content);
                } catch (e) {
                    console.error('Markdown parsing error:', e);
                    messageDiv.textContent = content;
                }
            } else {
                messageDiv.textContent = content;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function searchLocation(query) {
            clearTimeout(searchTimeout);
            
            const resultsDiv = document.getElementById('location-results');
            
            if (!query || query.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search-location?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.locations && data.locations.length > 0) {
                        resultsDiv.innerHTML = data.locations.map(loc => `
                            <div class="location-item" onclick="selectLocation(${loc.latitude}, ${loc.longitude}, '${loc.name.replace(/'/g, "\\'")}')">
                                ${loc.name}
                            </div>
                        `).join('');
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Location search error:', error);
                }
            }, 500);
        }

        function selectLocation(lat, lon, name) {
            document.getElementById('latitude').value = lat.toFixed(4);
            document.getElementById('longitude').value = lon.toFixed(4);
            document.getElementById('location-search').value = name;
            document.getElementById('location-results').style.display = 'none';
        }

        // Hide location results when clicking outside
        document.addEventListener('click', function(event) {
            const searchBox = document.querySelector('.location-search');
            if (searchBox && !searchBox.contains(event.target)) {
                document.getElementById('location-results').style.display = 'none';
            }
        });

        // Auto-detect timezone on page load
        window.addEventListener('load', function() {
            const offset = -new Date().getTimezoneOffset() / 60;
            document.getElementById('detected-tz').textContent = `UTC${offset >= 0 ? '+' : ''}${offset}`;
            
            // Try to select the detected timezone
            const tzSelect = document.getElementById('timezone');
            const matchingOption = Array.from(tzSelect.options).find(opt =>
                parseFloat(opt.value) === offset
            );
            if (matchingOption) {
                tzSelect.value = matchingOption.value;
            }
        });

        async function calculateChart(event) {
            event.preventDefault();
            
            const datetime = document.getElementById('datetime').value;
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const timezoneOffset = parseFloat(document.getElementById('timezone').value);
            const resultsDiv = document.getElementById('chart-results');
            const calcBtn = document.getElementById('calc-btn');

            calcBtn.disabled = true;
            calcBtn.innerHTML = '<span class="loading"></span> Calculating...';

            try {
                const response = await fetch('/api/calculate-chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        datetime: datetime,
                        latitude: latitude,
                        longitude: longitude,
                        timezone_offset: timezoneOffset
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentChartData = data.chart;
                    // Store original input data for Rasi chart generation
                    currentInputData = {
                        datetime: datetime,
                        latitude: latitude,
                        longitude: longitude,
                        timezone_offset: timezoneOffset
                    };
                    displayChartResults(data.chart);
                    updateSavedChartsList();  // Update saved charts list after calculation
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            } finally {
                calcBtn.disabled = false;
                calcBtn.innerHTML = 'Calculate Chart';
            }
        }

        function displayChartResults(chart) {
            const resultsDiv = document.getElementById('chart-results');
            
            let html = `
                <h3>üìç Chart Information</h3>
                <div class="planet-info">
                    <div class="planet-name">Ascendant (Lagna)</div>
                    <div class="planet-details">
                        ${chart.ascendant.sign} ${chart.ascendant.degree_in_sign.toFixed(2)}¬∞
                    </div>
                </div>

                <h3 style="margin-top: 20px;">üåü Planetary Positions</h3>
            `;

            for (const [planet, data] of Object.entries(chart.planets)) {
                const retrogradeSymbol = data.is_retrograde ? ' ‚Ñû' : '';
                const combustSymbol = data.is_combust ? ' üî•' : '';
                const direction = data.speed >= 0 ? '‚Üí' : '‚Üê';
                
                html += `
                    <div class="planet-info">
                        <div class="planet-name">${planet}${retrogradeSymbol}${combustSymbol}</div>
                        <div class="planet-details">
                            ${data.sign} ${data.degree_in_sign.toFixed(2)}¬∞ ‚Ä¢
                            ${data.nakshatra} (Pada ${data.pada})<br>
                            Speed: ${direction} ${Math.abs(data.speed).toFixed(4)}¬∞/day
                            ${data.is_retrograde ? ' (Retrograde)' : ''}
                            ${data.is_combust ? ` (Combust: ${data.combustion_distance.toFixed(2)}¬∞ from Sun)` : ''}
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        async function generateRasiChart() {
            if (!currentChartData || !currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const displayDiv = document.getElementById('rasi-chart-display');
            displayDiv.innerHTML = '<p style="text-align: center;">Generating chart...</p>';

            try {
                const response = await fetch('/api/generate-rasi-chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentInputData)
                });

                const data = await response.json();

                if (data.success) {
                    displayRasiChart(data);
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }

            } catch (error) {
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayRasiChart(chartData, targetDivId = 'rasi-chart-display') {
            const displayDiv = document.getElementById(targetDivId);
            
            // South Indian chart: SIGN positions in grid (fixed layout)
            // Layout shows which SIGN NUMBER is in each grid position
            // Sign 1 = Aries, Sign 2 = Taurus, ... Sign 12 = Pisces
            const signLayout = [
                12, 1, 2, 3,     // Row 1
                11, 0, 0, 4,     // Row 2 (0 means empty middle cells)
                10, 0, 0, 5,     // Row 3 (0 means empty middle cells)
                9, 8, 7, 6       // Row 4
            ];
            
            let html = `
                <div class="rasi-chart-container">
                    <h3 style="text-align: center; margin-bottom: 15px;">
                        Ascendant: ${chartData.ascendant.sign} ${chartData.ascendant.degree.toFixed(2)}¬∞
                    </h3>
                    <div class="rasi-chart">
            `;

            // Build the chart grid
            for (let i = 0; i < 16; i++) {
                const signNum = signLayout[i];
                
                // Handle empty cells (middle positions)
                if (signNum === 0) {
                    html += `<div class="rasi-house" style="background: #f5f5f5; border: none;"></div>`;
                    continue;
                }
                
                const sign = chartData.signs[signNum];
                const planets = sign.planets || [];
                const hasAscendant = sign.has_ascendant;
                
                html += `
                    <div class="rasi-house">
                        <div class="house-number">${signNum}</div>
                        <div class="house-sign">${sign.sign}</div>
                        <div class="house-planets">
                            ${hasAscendant ? '<span class="planet-symbol ascendant-marker" title="Ascendant">ASC</span> ' : ''}
                            ${planets.map(p => {
                                const prefix = p.name.substring(0, 2).toUpperCase();
                                const retrograde = p.is_retrograde ? '‚Ñû' : '';
                                const combust = p.is_combust ? 'üî•' : '';
                                const title = `${p.name} ${p.degree.toFixed(2)}¬∞${p.is_retrograde ? ' (Retrograde)' : ''}${p.is_combust ? ' (Combust)' : ''}`;
                                return `<span class="planet-symbol" title="${title}">${prefix}${retrograde}${combust}</span>`;
                            }).join(' ')}
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                    <div style="margin-top: 20px; font-size: 0.9rem;">
                        <h4>Legend:</h4>
                        <p><strong>Planet Abbreviations:</strong> ASC = Ascendant, SU = Sun, MO = Moon, MA = Mars, ME = Mercury,
                           JU = Jupiter, VE = Venus, SA = Saturn, RA = Rahu, KE = Ketu</p>
                        <p><strong>Special Symbols:</strong> ‚Ñû = Retrograde, üî• = Combust</p>
                        <p><strong>Chart Layout:</strong> South Indian Rasi Chart (D1) - Signs are in fixed positions</p>
                        <p><strong>Sign Numbers:</strong> 1=Aries, 2=Taurus, 3=Gemini, 4=Cancer, 5=Leo, 6=Virgo,
                           7=Libra, 8=Scorpio, 9=Sagittarius, 10=Capricorn, 11=Aquarius, 12=Pisces</p>
                        <p>Layout: Row 1: 12,1,2,3 | Row 2: 11,4 | Row 3: 10,5 | Row 4: 9,8,7,6</p>
                    </div>
                </div>
            `;

            displayDiv.innerHTML = html;
        }

        async function calculateShadbala() {
            if (!currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const displayDiv = document.getElementById('shadbala-results');
            displayDiv.innerHTML = '<p style="text-align: center;">Calculating Shadbala...</p>';

            try {
                const response = await fetch('/api/calculate-shadbala', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentInputData)
                });

                const data = await response.json();

                if (data.success) {
                    displayShadbalaResults(data.shadbala);
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayShadbalaResults(shadbala) {
            const displayDiv = document.getElementById('shadbala-results');
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            
            for (const [planet, data] of Object.entries(shadbala)) {
                const strength = data.rupas || 0;
                const minReq = data.minimum_required || 5;
                const ratio = data.ratio || 1;
                const category = strength >= 6 ? 'Very Strong' : strength >= 5 ? 'Strong' : strength >= 4 ? 'Moderate' : strength >= 3 ? 'Weak' : 'Very Weak';
                const color = strength >= minReq ? '#28a745' : strength >= minReq * 0.8 ? '#ffc107' : '#dc3545';
                
                html += `
                    <div class="planet-info" style="border-left: 4px solid ${color};">
                        <div class="planet-name">${planet}</div>
                        <div class="planet-details">
                            <strong>Total Shadbala:</strong> ${data.total.toFixed(2)} Shashtiamsas<br>
                            <strong>In Rupas:</strong> ${strength.toFixed(2)} Rupas<br>
                            <strong>Minimum Required:</strong> ${minReq.toFixed(1)} Rupas<br>
                            <strong>Ratio:</strong> ${ratio.toFixed(2)} (${ratio >= 1 ? 'Meets' : 'Below'} requirement)<br>
                            <strong>Category:</strong> ${category}<br>
                `;
                
                // Ishta and Kashta Phala
                if (data.ishta_phala !== undefined) {
                    html += `<strong>Ishta Phala:</strong> ${data.ishta_phala.toFixed(2)}<br>`;
                    html += `<strong>Kashta Phala:</strong> ${data.kashta_phala.toFixed(2)}<br>`;
                }
                
                html += '<br><strong>Detailed Components:</strong><br>';
                
                // Sthana Bala details
                const sthana = data.components?.sthana_bala;
                if (sthana && typeof sthana === 'object') {
                    html += `<details style="margin-top: 5px;"><summary style="cursor: pointer; color: #667eea;">Sthana Bala: ${sthana.total.toFixed(2)}</summary>`;
                    html += `<div style="margin-left: 15px; margin-top: 5px;">`;
                    html += `‚Ä¢ Uchcha Bala: ${sthana.uchcha_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Saptavargaja Bala: ${sthana.saptavargaja_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Ojayugmarasyamsa Bala: ${sthana.ojayugmarasyamsa_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Kendra Bala: ${sthana.kendra_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Drekkana Bala: ${sthana.drekkana_bala.toFixed(2)}<br>`;
                    html += `</div></details>`;
                } else {
                    html += `‚Ä¢ Sthana Bala: ${typeof sthana === 'number' ? sthana.toFixed(2) : '0.00'}<br>`;
                }
                
                // Kala Bala details
                const kala = data.components?.kala_bala;
                if (kala && typeof kala === 'object') {
                    html += `<details style="margin-top: 5px;"><summary style="cursor: pointer; color: #667eea;">Kala Bala: ${kala.total.toFixed(2)}</summary>`;
                    html += `<div style="margin-left: 15px; margin-top: 5px;">`;
                    html += `‚Ä¢ Nathonnatha Bala: ${kala.nathonnatha_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Paksha Bala: ${kala.paksha_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Tribhaga Bala: ${kala.tribhaga_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Abda Bala: ${kala.abda_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Masa Bala: ${kala.masa_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Vara Bala: ${kala.vara_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Hora Bala: ${kala.hora_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Ayana Bala: ${kala.ayana_bala.toFixed(2)}<br>`;
                    html += `‚Ä¢ Yuddha Bala: ${kala.yuddha_bala.toFixed(2)}<br>`;
                    html += `</div></details>`;
                } else {
                    html += `‚Ä¢ Kala Bala: ${typeof kala === 'number' ? kala.toFixed(2) : '0.00'}<br>`;
                }
                
                // Other components
                html += `‚Ä¢ Dig Bala: ${(data.components?.dig_bala || 0).toFixed(2)}<br>`;
                html += `‚Ä¢ Chesta Bala: ${(data.components?.cheshta_bala || 0).toFixed(2)}<br>`;
                html += `‚Ä¢ Naisargika Bala: ${(data.components?.naisargika_bala || 0).toFixed(2)}<br>`;
                html += `‚Ä¢ Drik Bala: ${(data.components?.drik_bala || 0).toFixed(2)}<br>`;
                
                html += `</div></div>`;
            }
            
            html += '</div>';
            displayDiv.innerHTML = html;
        }

        async function calculateBhavabala() {
            if (!currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const displayDiv = document.getElementById('bhavabala-results');
            displayDiv.innerHTML = '<p style="text-align: center;">Calculating Bhavabala...</p>';

            try {
                const response = await fetch('/api/calculate-bhavabala', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentInputData)
                });

                const data = await response.json();

                if (data.success) {
                    displayBhavabalaResults(data.bhavabala);
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayBhavabalaResults(bhavabala) {
            const displayDiv = document.getElementById('bhavabala-results');
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">';
            
            const houseSignificance = {
                1: 'Self, Personality, Health',
                2: 'Wealth, Family, Speech',
                3: 'Siblings, Courage, Communication',
                4: 'Mother, Home, Property',
                5: 'Children, Intelligence, Creativity',
                6: 'Enemies, Debts, Health Issues',
                7: 'Spouse, Partnership, Business',
                8: 'Longevity, Transformation, Occult',
                9: 'Fortune, Father, Religion',
                10: 'Career, Status, Authority',
                11: 'Gains, Friends, Aspirations',
                12: 'Losses, Expenses, Liberation'
            };
            
            for (let house = 1; house <= 12; house++) {
                const data = bhavabala[house];
                if (!data) continue;
                
                const strength = data.rupas || 0;
                const color = strength >= 9 ? '#28a745' : strength >= 7 ? '#6c757d' : strength >= 5 ? '#ffc107' : '#dc3545';
                
                html += `
                    <div class="planet-info" style="border-left: 4px solid ${color};">
                        <div class="planet-name">House ${house}</div>
                        <div class="planet-details">
                            <small style="color: #666;">${houseSignificance[house]}</small><br><br>
                            <strong>Total Bhavabala:</strong> ${data.total.toFixed(2)} Shashtiamsas<br>
                            <strong>In Rupas:</strong> ${strength.toFixed(2)} Rupas<br>
                            <strong>Strength Category:</strong> ${data.strength_category}<br><br>
                            <strong>Components:</strong><br>
                            ‚Ä¢ Bhavadhipati Bala: ${(data.components?.bhavadhipati_bala || 0).toFixed(2)}<br>
                            ‚Ä¢ Bhavdig Bala: ${(data.components?.bhavdig_bala || 0).toFixed(2)}<br>
                            ‚Ä¢ Bhavdrishti Bala: ${(data.components?.bhavdrishti_bala || 0).toFixed(2)}<br>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            displayDiv.innerHTML = html;
        }

        async function calculateDasha() {
            if (!currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const displayDiv = document.getElementById('dasha-results');
            displayDiv.innerHTML = '<p style="text-align: center;">Calculating Dasha...</p>';

            try {
                const response = await fetch('/api/calculate-dasha', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentInputData)
                });

                const data = await response.json();

                if (data.success) {
                    displayDashaResults(data);
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayDashaResults(data) {
            const displayDiv = document.getElementById('dasha-results');
            const current = data.current_dasha;
            const timeline = data.timeline;
            
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea;">Current Dasha Period</h3>
                    <div class="planet-info">
                        <div class="planet-name">Mahadasha: ${current.mahadasha.planet}</div>
                        <div class="planet-details">
                            From: ${new Date(current.mahadasha.start_date).toLocaleDateString()}<br>
                            To: ${new Date(current.mahadasha.end_date).toLocaleDateString()}<br>
                            Duration: ${current.mahadasha.duration_years} years
                        </div>
                    </div>
            `;
            
            if (current.antardasha) {
                html += `
                    <div class="planet-info" style="margin-top: 10px;">
                        <div class="planet-name">Antardasha: ${current.antardasha.planet}</div>
                        <div class="planet-details">
                            From: ${new Date(current.antardasha.start_date).toLocaleDateString()}<br>
                            To: ${new Date(current.antardasha.end_date).toLocaleDateString()}<br>
                            Duration: ${current.antardasha.duration_years} years
                        </div>
                    </div>
                `;
            }
            
            html += '</div><h3 style="color: #667eea; margin-top: 30px;">Mahadasha Timeline</h3>';
            
            for (const md of timeline.mahadashas) {
                html += `
                    <div class="planet-info" style="margin-bottom: 10px;">
                        <div class="planet-name">${md.planet} Mahadasha</div>
                        <div class="planet-details">
                            ${new Date(md.start_date).toLocaleDateString()} - ${new Date(md.end_date).toLocaleDateString()}<br>
                            Duration: ${md.duration_years} years<br>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #667eea;">View Antardashas</summary>
                                <div style="margin-top: 10px;">
                                    ${md.antardashas.map(ad => `
                                        <div style="padding: 5px; margin: 5px 0; background: #f0f0f0; border-radius: 5px;">
                                            <strong>${ad.planet}</strong>: ${new Date(ad.start_date).toLocaleDateString()} - ${new Date(ad.end_date).toLocaleDateString()}
                                            (${ad.duration_years.toFixed(2)} years)
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            }
            
            displayDiv.innerHTML = html;
        }

        async function calculateNakshatraAttributes() {
            if (!currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const displayDiv = document.getElementById('nakshatra-results');
            displayDiv.innerHTML = '<p style="text-align: center;">Calculating Nakshatra Attributes...</p>';

            try {
                const response = await fetch('/api/calculate-nakshatra-attributes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentInputData)
                });

                const data = await response.json();

                if (data.success) {
                    displayNakshatraResults(data.attributes);
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        function displayNakshatraResults(attributes) {
            const displayDiv = document.getElementById('nakshatra-results');
            
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea;">Jaimini Karakas (Planetary Significators)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            `;
            
            for (const [karaka, data] of Object.entries(attributes.karakas || {})) {
                html += `
                    <div class="planet-info">
                        <div class="planet-name">${karaka}</div>
                        <div class="planet-details">
                            <strong>Planet:</strong> ${data.planet}<br>
                            <strong>Degree:</strong> ${data.degree_in_sign}¬∞<br>
                            <strong>Significance:</strong> ${data.significance}
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            
            // Moon Nakshatra Attributes
            const moon = attributes.moon_nakshatra_attributes || {};
            if (moon.nakshatra) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #667eea;">Moon Nakshatra: ${moon.nakshatra}</h3>
                        <div class="planet-info">
                            <div class="planet-details">
                                <strong>Lord:</strong> ${moon.lord}<br>
                                <strong>Yoni:</strong> ${moon.yoni.full}<br>
                                <strong>Gana:</strong> ${moon.gana} (Nature)<br>
                                <strong>Nadi:</strong> ${moon.nadi} (Dosha)<br>
                                <strong>Varna:</strong> ${moon.varna} (Caste)<br>
                                <strong>Tattva:</strong> ${moon.tattva} (Element)<br>
                                <strong>Deity:</strong> ${moon.deity}<br>
                                <strong>Symbol:</strong> ${moon.symbol}<br>
                                <strong>Guna:</strong> ${moon.guna}<br>
                                <strong>Direction:</strong> ${moon.direction}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Ascendant Nakshatra
            const asc = attributes.ascendant_nakshatra_attributes || {};
            if (asc.nakshatra) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #667eea;">Ascendant Nakshatra: ${asc.nakshatra}</h3>
                        <div class="planet-info">
                            <div class="planet-details">
                                <strong>Lord:</strong> ${asc.lord}<br>
                                <strong>Yoni:</strong> ${asc.yoni.full}<br>
                                <strong>Gana:</strong> ${asc.gana}<br>
                                <strong>Deity:</strong> ${asc.deity}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            displayDiv.innerHTML = html;
        }

        async function generateDivisionalChart() {
            if (!currentChartData || !currentInputData) {
                alert('Please calculate a birth chart first in the Chart Calculator tab');
                return;
            }

            const varga = document.getElementById('varga-select').value;
            const displayDiv = document.getElementById('divisional-chart-display');
            
            // Clear previous content and show loading
            displayDiv.innerHTML = '<p style="text-align: center; padding: 50px;"><span class="loading" style="display: inline-block;"></span> Generating ' + varga + ' chart...</p>';

            try {
                const response = await fetch('/api/generate-divisional-chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...currentInputData,
                        varga: varga
                    })
                });

                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                console.log('Divisional chart data received:', data);

                if (data.success) {
                    // Force clear and redraw
                    displayDiv.innerHTML = '';
                    displayRasiChart(data, 'divisional-chart-display');  // Pass the correct div ID
                } else {
                    displayDiv.innerHTML = `<p style="color: red;">Error: ${data.error || 'Unknown error'}</p>`;
                }

            } catch (error) {
                console.error('Divisional chart error:', error);
                displayDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>